@model IEnumerable<travel_agency_service.Models.ViewModels.TripGalleryItemViewModel>

@{
    ViewData["Title"] = "Trip Gallery";
}

<div class="container mt-5">
    <h1 class="mb-4 text-center">Trip Gallery</h1>

    @if (TempData["Message"] != null)
    {
        <div class="alert alert-info text-center">
            @TempData["Message"]
        </div>
    }

    <!-- 🔍 Filter Button -->
    <div class="text-center mb-4">
        <button class="btn btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#filterModal">
            🔍 Filter Trips
        </button>
    </div>

    <!-- 🧳 Trips -->
    <div class="row">
        @foreach (var item in Model)
        {
            var p = item.Package;
            var waitingCount = item.WaitingCount;
            var isUserWaiting = item.IsUserWaiting;
            int? userPosition = item.UserPosition;

            <div class="col-md-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        @if (item.BookingCount >= 3)
                        {
                            <span class="badge bg-warning text-dark mb-2">
                                ⭐ Popular
                            </span>
                        }

                        <h5 class="card-title">
                            @p.Destination, @p.Country
                        </h5>

                        <p class="card-text">
                            <strong>Dates:</strong><br />
                            @p.StartDate.ToShortDateString() -
                            @p.EndDate.ToShortDateString()
                        </p>

                        <p class="card-text">
                            <strong>Price:</strong><br />
                            @if (p.HasActiveDiscount())
                            {
                                <span style="text-decoration: line-through; color: gray;">
                                    ₪@p.BasePrice
                                </span>
                                <strong style="color:red;">
                                    ₪@p.DiscountPrice
                                </strong>
                            }
                            else
                            {
                                <span>₪@p.BasePrice</span>
                            }
                        </p>

                        <p class="card-text">
                            <strong>Available rooms:</strong>
                            @p.AvailableRooms
                        </p>

                        @if (p.AvailableRooms == 0 && waitingCount > 0)
                        {
                            <p class="card-text text-warning">
                                <strong>@waitingCount</strong> other people are waiting for this trip
                            </p>
                        }

                        @if (isUserWaiting)
                        {
                            <div class="alert alert-info p-2">
                                <strong>You are already on the waiting list</strong>
                            </div>
                        }

                        @if (isUserWaiting && userPosition != null)
                        {
                            <p class="card-text text-info">
                                You are <strong>#@userPosition</strong> in line
                            </p>
                        }

                        <div class="mt-auto">
                            @if (p.AvailableRooms > 0 && (!isUserWaiting || userPosition == 1))
                            {
                                <form asp-action="Book" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="packageId" value="@p.Id" />
                                    <button type="submit" class="btn btn-success w-100">
                                        Book
                                    </button>
                                </form>
                            }
                            else
                            {
                                <button class="btn btn-secondary w-100 mb-2" disabled>
                                    No rooms available
                                </button>

                                @if (!isUserWaiting)
                                {
                                    <form asp-action="JoinWaitingList" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="packageId" value="@p.Id" />
                                        <button type="submit" class="btn btn-outline-primary w-100">
                                            Join waiting list
                                        </button>
                                    </form>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- 🪟 Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="get">
                <div class="modal-header">
                    <h5 class="modal-title">Filter Trips</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">

                        <div class="col-md-6">
                            <label class="form-label">Sort By</label>
                            <select name="sortBy" class="form-control">
                                <option value="">None</option>
                                <option value="price_asc">Price (Low → High)</option>
                                <option value="price_desc">Price (High → Low)</option>
                                <option value="date">Travel Date</option>
                                <option value="popular">Most Popular</option>

                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Category</label>
                            <select name="category" class="form-control">
                                <option value="">All</option>
                                @foreach (var type in Enum.GetValues(typeof(PackageType)))
                                {
                                    <option value="@type">@type</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Destination</label>
                            <input type="text" name="destination" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Country</label>
                            <input type="text" name="country" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Min Price</label>
                            <input type="number" name="minPrice" class="form-control" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Max Price</label>
                            <input type="number" name="maxPrice" class="form-control" />
                        </div>

                        <div class="col-md-12 form-check mt-2">
                            <input type="checkbox"
                                   name="onlyDiscounted"
                                   value="true"
                                   class="form-check-input"
                                   id="discountCheck" />
                            <label class="form-check-label" for="discountCheck">
                                Only discounted trips
                            </label>
                        </div>

                    </div>
                </div>

                <div class="modal-footer">
                    <a asp-action="Gallery" class="btn btn-secondary">
                        Clear
                    </a>
                    <button type="submit" class="btn btn-primary">
                        Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
