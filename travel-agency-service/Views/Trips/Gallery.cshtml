@model IEnumerable<travel_agency_service.Models.ViewModels.TripGalleryItemViewModel>

@{
    ViewData["Title"] = "Trips";
}
@if (TempData["Message"] != null)
{
    <div class="alert alert-success text-center">
        @TempData["Message"]
    </div>
}

<section class="trips-hero">
    <div class="hero-overlay"></div>

    <div class="hero-inner">
        <h1 class="hero-title">
            Ready for Your Next Trip?
        </h1>
        <p class="hero-subtitle">Find Personalized Vacation Packages</p>
    </div>

    <!-- 🔍 Search box בתחתית התמונה -->
    <form method="get" asp-action="Search" class="trip-search-box text-end">

        <!-- יעד -->
        <input type="text"
               name="destination"
               class="form-control text-end"
               placeholder="Destination" />

        <!-- תאריכים -->
        <input type="date"
               name="startDate"
               class="form-control text-end" />

        <input type="date"
               name="endDate"
               class="form-control text-end" />

        <!-- מחיר -->
        <input type="number"
               name="minPrice"
               class="form-control text-end"
               placeholder="Min Price" />

        <input type="number"
               name="maxPrice"
               class="form-control text-end"
               placeholder="Max Price" />

        <!-- קטגוריה -->
        <select name="category" class="form-select ">
            <option value="">All Categories</option>
            @foreach (var type in Enum.GetValues(typeof(PackageType)))
            {
                <option value="@type">@type</option>
            }
        </select>

        <button type="submit" class="btn btn-primary search-btn">
            Search
        </button>
    </form>


</section>

<section class="deals-section">
    <h2 class="deals-title">Hot Deals</h2>

    <div class="deals-container">
        <!-- חץ ימינה -->
        <button class="deals-arrow right" data-direction="right">
            ❯
        </button>

        <div class="deals-wrapper" id="dealsWrapper">
            @foreach (var item in Model.Where(m => m.Package.HasActiveDiscount()))
            {
                var p = item.Package;
                <a asp-action="Details" asp-route-id="@p.Id" class="text-decoration-none">
                    <div class="deal-card">
                        <div class="deal-image">
                            <img src="@p.MainImageUrl" alt="@p.Destination" />
                        </div>
                        <div class="deal-info">
                            <h5>@p.Destination</h5>
                            <span>@p.GetCurrentPrice()₪</span>
                        </div>
                    </div>
                </a>



            }
        </div>

        <!-- חץ שמאלה -->
        <!-- חץ שמאלה -->
        <button class="deals-arrow left" data-direction="left">
            ❮
        </button>
    </div>
</section>
<section class="popular-section">
    <h2 class="popular-title">Popular Right Now</h2>

    <div class="popular-container">
        <!-- חץ ימין -->
        <button class="popular-arrow right">
            ❯
        </button>
        <!-- קרוסלה -->
        <div class="popular-wrapper" id="popularWrapper">
            @foreach (var item in Model.Where(m => m.BookingCount >= 3))
            {
                var p = item.Package;
                <a asp-action="Details" asp-route-id="@p.Id" class="text-decoration-none">
                    <div class="deal-card">
                        <div class="deal-image">
                            <img src="@p.MainImageUrl" alt="@p.Destination" />
                        </div>
                        <div class="deal-info">
                            <h5>@p.Destination</h5>
                            <span>@p.GetCurrentPrice()₪</span>
                        </div>
                    </div>
                </a>



            }
        </div>

        <!-- חץ שמאל -->
        <button class="popular-arrow left">
            ❮
        </button>
    </div>
</section>
    <section class="container-fluid my-5 px-5">

        <h2 class="fw-bold mb-4 text-center">
            Browse Trips
        </h2>

        <!-- Filters -->
        <form method="get" asp-action="Gallery" class="row g-3 mb-4">

            <!-- Category -->
            <div class="col-md-3">
                <select name="category" class="form-select">
                    <option value="">All Categories</option>
                    @foreach (var type in Enum.GetValues(typeof(PackageType)))
                    {
                        <option value="@type"
                                selected="@(ViewBag.Category?.ToString() == type.ToString())">
                            @type
                        </option>
                    }
                </select>
            </div>

            <!-- Sort -->
            <div class="col-md-3">
                <select name="sortBy" class="form-select">
                    <option value="">Sort By</option>
                    <option value="price_asc"
                            selected="@(ViewBag.SortBy?.ToString() == "price_asc")">
                        Price ↑
                    </option>
                    <option value="price_desc">Price ↓</option>
                    <option value="popular">Most Popular</option>
                    <option value="date">Travel Date</option>
                </select>
            </div>

            <div class="col-md-2">
                <button class="btn btn-primary w-100">
                    Apply
                </button>
            </div>

        </form>

        <!-- Trips Cards -->
      <div class="gallery-cards">

    @foreach (var item in Model)
    {
        var p = item.Package;
        var hasDiscount = p.HasActiveDiscount();

        <div class="trip-card">

            <!-- תמונה -->
            <div class="trip-image">
                <img src="@p.MainImageUrl" alt="@p.Destination" />
                    <span class="badge category">
                        @p.PackageType
                    </span>

                @if (hasDiscount)
                {
                    <span class="badge discount">
                        חיסכון
                        @{
                            var percent =
                                (int)((p.BasePrice - p.GetCurrentPrice()) / p.BasePrice * 100);
                        }%
                    </span>
                }

                <span class="badge new">חדש</span>
                    @{
                        var rating = item.LatestReviews.Any()
                        ? Math.Round(item.LatestReviews.Average(r => r.Rating), 1)
                        : (double?)null;
                    }

                    @if (rating != null)
                    {
                        <div class="rating-badge">
                            <span class="star">★</span>
                            <span class="rating-value">@rating</span>
                        </div>
                    }
            </div>

            <!-- תוכן -->
            <div class="trip-content">

                <h4 class="trip-title">
                    @p.Destination
                </h4>

                <div class="trip-location">
                    📍 @p.Country
                </div>

                <p class="trip-desc">
                    @p.Description?.Substring(0, Math.Min(90, p.Description.Length))...
                </p>

                <div class="trip-info">
                    <span>👤 +18</span>
                        <span>
                            📅 @p.StartDate.ToString("dd/MM/yyyy") –
                            @p.EndDate.ToString("dd/MM/yyyy")
                        </span>

                </div>

                <!-- מחיר -->
                <div class="trip-price">
                    @if (hasDiscount)
                    {
                        <span class="old-price">
                            ₪@p.BasePrice
                        </span>
                    }

                    <span class="new-price">
                        ₪@p.GetCurrentPrice()
                    </span>
                        <span class="per-person">per person</span>
                </div>

                <!-- כפתורים -->
                <div class="trip-actions">
                    <a asp-action="Details"
                       asp-route-id="@p.Id"
                       class="btn-primary">
                        For details and Book
                    </a>

                   
                </div>

            </div>
        </div>
    }

</div>

    </section>

        


@if (ViewBag.SiteReviews != null && ViewBag.SiteReviews.Count > 0)
{
        <section class="container-fluid my-5 px-4">
            <h2 class="fw-bold mb-4 text-center">
                What users think about our service
            </h2>

            <div class="d-flex justify-content-center">
                <div class="col-xl-4 col-lg-5 col-md-7 col-sm-10">
                    <div class="site-reviews-scroll">
                        @foreach (var review in ViewBag.SiteReviews)
                        {
                            <div class="border rounded p-3 mb-3">
                                <strong>@review.Rating ★</strong>
                                <p class="mb-1">@review.Comment</p>
                                <small class="text-muted">
                                    @review.CreatedAt.ToShortDateString()
                                </small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </section>

}
