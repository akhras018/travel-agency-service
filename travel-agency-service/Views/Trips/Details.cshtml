@model travel_agency_service.Models.ViewModels.TripDetailsViewModel

@{
    ViewData["Title"] = "Trip Details";
    var package = Model.Package;

    var LastBookingDate = package.LastBookingDate;
    var cancellationDeadline = package.CancellationDeadline;
    var canCancel = !cancellationDeadline.HasValue || DateTime.UtcNow <= cancellationDeadline.Value;
}

<!-- HERO -->
<section class="trips-hero trips-hero--small"
         style="background-image:url('/images/pexels-pixabay-237272.jpg')">
    <div class="hero-overlay"></div>
    <div class="hero-inner">
        <h2 class="hero-title">@package.Destination, @package.Country</h2>
        <p class="hero-subtitle">
            @package.StartDate.ToShortDateString()
            -
            @package.EndDate.ToShortDateString()
        </p>
    </div>
</section>


<!-- CONTENT -->
<section class="container my-5">
    <div class="row g-5">

        <!-- Right side -->
        <div class="col-lg-8">

            <!-- Gallery -->
            @if (Model.GalleryImages.Any())
            {
                <div class="row g-3 mb-4">
                    @foreach (var img in Model.GalleryImages)
                    {
                        <div class="col-md-4">
                            <img src="@img"
                                 class="img-fluid rounded shadow-sm clickable-image"
                                 style="height:180px;object-fit:cover"
                                 onclick="openImageModal(this.src)" />
                        </div>
                    }
                </div>
            }

            <!-- Description -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">Package Description</h5>
                    <p>@package.Description</p>

                    <hr />
                    <p><strong>Start Date::</strong>@package.StartDate.ToShortDateString()</p>
                    <p><strong>End Date:</strong> @package.EndDate.ToShortDateString()</p>

                    <p><strong>Package Type:</strong> @package.PackageType</p>
                    <p><strong>Age Restriction:</strong> From age @package.AgeLimitation and up</p>
                    <p><strong>Available Rooms:</strong> @package.AvailableRooms</p>
                     <div class="hotel-details">
        <h5>🏨 Hotel Details</h5>

        <ul>
                            <li><b>Hotel:</b> @package.HotelName</li>
                            <li><b>Meals Included:</b> @package.HotelMeals</li>
            <li>
                <b>Website:</b>
                                <a href="@package.HotelWebsite" target="_blank">
                    Visit Hotel Website For More Informations.
                </a>
            </li>
        </ul>
    </div>

                    <hr />

                    <!-- Important Dates -->
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <strong>Latest booking date:</strong><br />

                            @if (LastBookingDate.HasValue)
                            {
                                var canBook = DateTime.UtcNow <= LastBookingDate.Value;

                                <span class="fw-bold @(canBook ? "text-success" : "text-danger")">
                                    @LastBookingDate.Value.ToShortDateString()
                                </span>

                                @if (!canBook)
                                {
                                    <div class="text-danger small">
                                        Booking period has ended
                                    </div>
                                }
                            }
                            else
                            {
                                <span class="text-muted">
                                    Booking available until sold out
                                </span>
                            }
                        </div>


                        <div class="col-md-6 mb-2">
                            <strong>Cancellation allowed until:</strong><br />
                            @if (cancellationDeadline.HasValue)
                            {
                                <span class="fw-bold @(canCancel ? "text-success" : "text-danger")">
                                    @cancellationDeadline.Value.ToShortDateString()
                                </span>

                                @if (!canCancel)
                                {
                                    <div class="text-danger small">
                                        Cancellation period has ended
                                    </div>
                                }
                            }
                            else
                            {
                                <span class="text-muted">Cancellation not available</span>
                            }
                        </div>

                        @{
                            var daysLeft = (Model.Package.StartDate.Date - DateTime.Today).Days;
                        }

                        @if (daysLeft > 0)
                        {
                            <p>
                                <strong>Departure:</strong>
                                In @daysLeft days
                            </p>
                        }

                    </div>

                </div>
            </div>
        </div>

        <!-- Left side – Booking -->
        <div class="col-lg-4">
            <div class="card shadow-lg">
                <div class="card-body">

                    <h5 class="mb-3">Package Booking</h5>

                    <!-- Price -->
                    <div class="mb-3">
                        @if (package.HasActiveDiscount())
                        {
                            <div class="text-muted text-decoration-line-through">
                                @package.BasePrice₪
                            </div>
                        }

                        <div class="fs-4 fw-bold text-danger" id="dynamicPrice">
                            @package.GetCurrentPrice()₪
                        </div>

                    </div>

                    <hr />

                    @if (Model.IsFull)
                    {
                        <div class="alert alert-warning text-center">
                            No rooms available
                        </div>

                        @if (User.Identity != null && User.Identity.IsAuthenticated)
                        {
                            if (!Model.IsUserWaiting)
                            {
                                <form asp-action="JoinWaitingList"
                                      asp-controller="Trips"
                                      method="post"
                                      class="mt-3">

                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="packageId" value="@package.Id" />

                                    <button type="submit" class="btn btn-outline-primary w-100">
                                        Join Waiting List
                                    </button>
                                </form>

                                <p class="small text-muted text-center mt-2">
                                    Currently waiting: @Model.WaitingCount users
                                </p>
                                @if (Model.EstimatedAvailableDate.HasValue)
                                {
                                    <p class="small text-muted text-center">
                                        Estimated availability:
                                        <strong>
                                            @Model.EstimatedAvailableDate.Value.ToShortDateString()
                                        </strong>
                                    </p>
                                }

                            }
                            else
                            {
                                <div class="alert alert-info text-center mt-3">
                                    You are already on the waiting list.<br />
                                    Your position: <strong>@Model.UserWaitingPosition</strong>

                                    @if (Model.EstimatedAvailableDate.HasValue)
                                    {
                                        <div class="small mt-2">
                                            Estimated availability:
                                            <strong>
                                                @Model.EstimatedAvailableDate.Value.ToShortDateString()
                                            </strong>
                                        </div>
                                    }
                                </div>
                            }

                        }
                        else
                        {
                            <a asp-area="Identity"
                               asp-page="/Account/Login"
                               asp-route-returnUrl="@Url.Action("Details", "Trips", new { id = package.Id })"
                               class="btn btn-primary w-100 mt-3">
                                Login to join waiting list
                            </a>
                        }
                    }

                    else if (DateTime.UtcNow > LastBookingDate)
                    {
                        <div class="alert alert-danger text-center">
                            Booking period has ended
                        </div>
                    }
                    else if (Model.AlreadyBooked)
                    {
                        <div class="alert alert-warning text-center">
                            You have already booked this trip
                        </div>
                    }
                    else if (package.LastBookingDate.HasValue &&
                    DateTime.UtcNow > package.LastBookingDate.Value)
                    {
                        <div class="alert alert-danger text-center">
                            Booking is no longer available
                        </div>
                    }
                    else
                    {
                        @if (User.Identity != null && User.Identity.IsAuthenticated)
                        {
                            <!-- ✅ משתמש מחובר -->

                            <form asp-action="Book"
                                  asp-controller="Trips"
                                  method="post"
                                  class="mb-2">

                                @Html.AntiForgeryToken()
                                <input type="hidden" name="packageId" value="@package.Id" />

                                <div class="mb-2">
                                    <label class="form-label">Number of Rooms</label>
                                    <select id="roomsSelect" name="rooms" class="form-select" onchange="renderRoomTypes()">
                                        @for (int i = 1; i <= package.AvailableRooms; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>

                                    <div id="roomTypesContainer" class="mt-3"></div>

                                    <input type="hidden" name="roomTypesJson" id="roomTypesJson" value="[]" />


                                </div>

                                <button type="submit" class="btn btn-outline-primary w-100">
                                    Book
                                </button>
                            </form>

                            <form asp-action="Book"
                                  asp-controller="Trips"
                                  method="post"
                                  class="mb-2"
                                  onsubmit="syncRooms(this)">

                                @Html.AntiForgeryToken()
                                <input type="hidden" name="packageId" value="@package.Id" />
                                <input type="hidden" name="payNow" value="true" />
                                <input type="hidden" name="rooms" class="rooms-hidden" />
                                <input type="hidden" name="roomTypesJson" class="roomtypes-hidden" />


                                <button type="submit" class="btn btn-primary w-100">
                                    Buy Now
                                </button>
                            </form>

                            <form asp-action="AddToCart"
                                  asp-controller="Cart"
                                  method="post"
                                  onsubmit="syncRooms(this)">

                                @Html.AntiForgeryToken()
                                <input type="hidden" name="packageId" value="@package.Id" />
                                <input type="hidden" name="rooms" class="rooms-hidden" />
                                <input type="hidden" name="roomTypesJson" class="roomtypes-hidden" />

                                <button type="submit"
                                        class="btn btn-outline-secondary w-100 btn-add-cart-rect">
                                    🛒 Add to Cart
                                </button>
                            </form>
                        }
                        else
                        {
                            <!-- 🔐 אורח -->

                            <a asp-area="Identity"
                               asp-page="/Account/Login"
                               asp-route-returnUrl="@Url.Action("Details", "Trips", new { id = package.Id })"
                               class="btn btn-primary w-100 mb-2">
                                Login to Book
                            </a>

                            <a asp-area="Identity"
                               asp-page="/Account/Login"
                               asp-route-returnUrl="@Url.Action("Details", "Trips", new { id = package.Id })"
                               class="btn btn-outline-secondary w-100">
                                Login to Add to Cart
                            </a>
                        }
                    }


                </div>
            </div>
            <!-- Reviews Card -->
            <div class="card shadow-sm mt-4">
                <div class="card-body">

                    <h5 class="fw-bold mb-3">⭐ Trip Reviews</h5>
                    <div class="site-reviews-scroll">

                    @if (!Model.Reviews.Any())
                    {
                        <div class="text-muted small">
                            No reviews yet. Be the first to review this trip.
                        </div>
                    }
                    else
                    {
                        @foreach (var review in Model.Reviews)
                        {
                            <div class="mb-3 pb-3 border-bottom">

                                <!-- Stars -->
                                <div class="mb-1">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= review.Rating)
                                        {
                                            <span class="text-warning">★</span>
                                        }
                                        else
                                        {
                                            <span class="text-secondary">☆</span>
                                        }
                                    }
                                </div>

                                <!-- Comment -->
                                <div class="small">
                                    @review.Comment
                                </div>

                                <!-- User + Date -->
                                <div class="text-muted small mt-1">
                                    @review.User.Email ·
                                    @review.CreatedAt.ToShortDateString()
                                </div>
                            </div>
                        }
                    }
                    </div>

                </div>
            </div>
            @if (Model.CanReview)
            {
                <div class="card mt-4">
                    <div class="card-body">
                        <h5>Rate this trip</h5>

                        <form asp-action="AddReview" asp-controller="Trips" method="post">
                            @Html.AntiForgeryToken()

                            <input type="hidden" name="TravelPackageId" value="@Model.Package.Id" />

                            <label>Rating</label>
                            <select name="Rating" class="form-select" required>
                                <option value="5">★★★★★</option>
                                <option value="4">★★★★</option>
                                <option value="3">★★★</option>
                                <option value="2">★★</option>
                                <option value="1">★</option>
                            </select>

                            <label class="mt-2">Comment</label>
                            <textarea name="Comment" class="form-control" required></textarea>

                            <button type="submit" class="btn btn-primary mt-3">
                                Submit Review
                            </button>
                        </form>

                    </div>
                </div>
            }


        </div>

    </div>
</section>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="close-btn">&times;</span>
    <img id="modalImage" />
</div>
<script>
    function syncRooms(form) {
        const rooms = document.getElementById("roomsSelect").value;
        form.querySelector('input[name="rooms"]').value = rooms;
    }
</script>
<script>
    function syncRooms(form) {
        const rooms = document.getElementById("roomsSelect").value;
        form.querySelector('input[name="rooms"]').value = rooms;
    }

    function openImageModal(src) {
        const modal = document.getElementById("imageModal");
        const modalImage = document.getElementById("modalImage");

        modalImage.src = src;
        modal.style.display = "flex";
    }

    function closeImageModal() {
        const modal = document.getElementById("imageModal");
        modal.style.display = "none";
    }
</script>
<script>
    const basePrice = @package.GetCurrentPrice();

    const roomExtras = {
        Single: 0,
        Double: 300,
        Suite: 700
    };

    const roomsSelect = document.getElementById("roomsSelect");
    const container = document.getElementById("roomTypesContainer");
    const priceBox = document.getElementById("dynamicPrice");
    const roomTypesInput = document.getElementById("roomTypesJson");

    function renderRoomTypes() {
        const rooms = parseInt(roomsSelect.value || "1");
        container.innerHTML = "";

        for (let i = 0; i < rooms; i++) {
            const select = document.createElement("select");
            select.className = "form-select mb-2 room-type";
            select.innerHTML = `
                <option value="Single">Single Room</option>
                <option value="Double">Double Room (+300₪)</option>
                <option value="Suite">Suite (+700₪)</option>
            `;
            select.addEventListener("change", updatePrice);
            container.appendChild(select);
        }

        updatePrice();
    }

    function updatePrice() {
        let total = 0;
        let types = [];

        document.querySelectorAll(".room-type").forEach(sel => {
            total += (basePrice + (roomExtras[sel.value] ?? 0));
            types.push(sel.value);
        });

        priceBox.innerText = total.toFixed(2) + "₪";
        roomTypesInput.value = JSON.stringify(types);
    }

    function syncToForm(form) {
        const rooms = roomsSelect.value;
        form.querySelector('input[name="rooms"]').value = rooms;

        const rt = form.querySelector('input[name="roomTypesJson"]');
        if (rt) rt.value = roomTypesInput.value;
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        renderRoomTypes(); // ✅ מציג מיד בלי לפתוח את הדרופדאון
    });

    // לקשר לטפסים
    document.querySelectorAll("form").forEach(f => {
        if (f.action.includes("/Trips/Book") || f.action.includes("/Cart/AddToCart")) {
            f.addEventListener("submit", () => syncToForm(f));
        }
    });
</script>
