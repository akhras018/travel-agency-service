@model IEnumerable<travel_agency_service.Models.ViewModels.TripGalleryItemViewModel>

@{
    ViewData["Title"] = "Search Results";
}

<div class="search-page">

    <!-- ================= HERO ================= -->
    <section class="trips-hero">
        <div class="hero-overlay"></div>

        <div class="search-summary-box">
            <div class="search-summary-header">
                @ViewBag.ResultsCount Results found
            </div>

            <div class="search-summary-item">
                <i class="bi bi-geo-alt"></i>
                <span>Destination:</span>
                <strong>@(ViewBag.Destination ?? "All")</strong>
            </div>

            <div class="search-summary-item">
                <i class="bi bi-calendar-event"></i>
                <span>Dates:</span>
                <strong>@(ViewBag.StartDate ?? "—") – @(ViewBag.EndDate ?? "—")</strong>
            </div>

            <div class="search-summary-item">
                <i class="bi bi-cash-stack"></i>
                <span>Price:</span>
                <strong>
                    @(ViewBag.MinPrice != null ? $"₪{ViewBag.MinPrice}" : "")
                    @(ViewBag.MaxPrice != null ? $" – ₪{ViewBag.MaxPrice}" : "")
                </strong>
            </div>

            <div class="search-summary-item">
                <i class="bi bi-bag"></i>
                <span>Category:</span>
                <strong>@(ViewBag.Category ?? "All")</strong>
            </div>
        </div>

        <!-- SEARCH FORM -->
        <form method="get" asp-action="Search" class="trip-search-box text-end">
            <input type="text" name="destination" class="form-control" placeholder="Destination"
                   value="@ViewBag.Destination" />

            <input type="date" name="startDate" class="form-control" value="@ViewBag.StartDate" />
            <input type="date" name="endDate" class="form-control" value="@ViewBag.EndDate" />

            <input type="number" name="minPrice" class="form-control" placeholder="Min Price"
                   value="@ViewBag.MinPrice" />
            <input type="number" name="maxPrice" class="form-control" placeholder="Max Price"
                   value="@ViewBag.MaxPrice" />

            <select name="category" class="form-select">
                <option value="">All Categories</option>
                @foreach (var type in Enum.GetValues(typeof(PackageType)))
                {
                    <option value="@type" selected="@(ViewBag.Category?.ToString() == type.ToString())">
                        @type
                    </option>
                }
            </select>

            <button type="submit" class="btn btn-primary search-btn">Search</button>
        </form>
    </section>

    <!-- ================= RESULTS ================= -->
    <section class="container-fluid my-5">
      

                <h3 class=" mb-4">Search Results</h3>

                @if (!Model.Any())
                {
                    <p class="text-end">No results found</p>
                }
                else
                {
                    <div class="gallery-cards">

                        @foreach (var item in Model)
                        {
                            var p = item.Package;
                            var hasDiscount = p.HasActiveDiscount();

                            <div class="trip-card">

                                <!-- תמונה -->
                                <div class="trip-image">
                                    <img src="@p.MainImageUrl" alt="@p.Destination" />
                                    <span class="badge category">
                                        @p.PackageType
                                    </span>

                                    @if (hasDiscount)
                                    {
                                        <span class="badge discount">
                                            חיסכון @((int)((p.BasePrice - p.GetCurrentPrice()) / p.BasePrice * 100))%
                                        </span>

                                    }

                                    <span class="badge new">חדש</span>
                                    @{
                                        var rating = item.LatestReviews.Any()
                                        ? Math.Round(item.LatestReviews.Average(r => r.Rating), 1)
                                        : (double?)null;
                                    }

                                    @if (rating != null)
                                    {
                                        <div class="rating-badge">
                                            <span class="star">★</span>
                                            <span class="rating-value">@rating</span>
                                        </div>
                                    }
                                </div>

                                <!-- תוכן -->
                                <div class="trip-content">

                                    <h4 class="trip-title">
                                        @p.Destination
                                    </h4>

                                    <div class="trip-location">
                                        📍 @p.Country
                                    </div>

                                    <p class="trip-desc">
                                        @p.Description?.Substring(0, Math.Min(90, p.Description.Length))...
                                    </p>

                                    <div class="trip-info">
                                        <span>👤 +@p.AgeLimitation</span>
                                        <span>
                                            📅 @p.StartDate.ToString("dd/MM/yyyy") –
                                            @p.EndDate.ToString("dd/MM/yyyy")
                                        </span>

                                    </div>

                                    <!-- מחיר -->
                                    <div class="trip-price">
                                        @if (hasDiscount)
                                        {
                                            <span class="old-price">
                                                ₪@p.BasePrice
                                            </span>
                                        }

                                        <span class="new-price">
                                            ₪@p.GetCurrentPrice()
                                        </span>
                                        <span class="per-person">per person</span>
                                    </div>

                                    <!-- כפתורים -->
                                    <div class="trip-actions">
                                        <a asp-action="Details"
                                           asp-route-id="@p.Id"
                                           class="btn-primary">
                                            For details and Book
                                        </a>


                                    </div>

                                </div>
                            </div>
                        }

                    </div>
                }
            
        
    </section>
</div>
